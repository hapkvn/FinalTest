<!DOCTYPE html>
<html>
<head>
    <title>H·ªá Th·ªëng Giao Th√¥ng Th√¥ng Minh</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; }
        #sidebar { width: 320px; padding: 20px; background: white; border-right: 1px solid #ddd; height: 100vh; z-index: 1000; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        #map { flex: 1; height: 100vh; background: #e5e9f2; }
        
        h2 { margin-top: 0; color: #2c3e50; }
        
        /* CSS cho Input */
        .input-group { margin-bottom: 5px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #007bff; outline: none; box-shadow: 0 0 5px rgba(0,123,255,0.2); }
        
        /* CSS cho n√∫t T√¨m ki·∫øm */
        button.search-btn { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; margin-top: 15px; }
        button.search-btn:hover { background: #0056b3; }
        button.search-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* --- CSS M·ªöI: N√∫t Ho√°n ƒê·ªïi (Swap) --- */
        .swap-container { 
            text-align: center; 
            margin: -10px 0; /* K√©o n√∫t ƒë√® l√™n kho·∫£ng c√°ch gi·ªØa 2 input */
            position: relative; 
            z-index: 10; 
            height: 30px; /* Chi·ªÅu cao v√πng ch·ª©a */
        }
        .swap-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #fff;
            border: 1px solid #ddd;
            color: #007bff;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .swap-btn:hover {
            background: #f8f9fa;
            transform: rotate(180deg); /* Hi·ªáu ·ª©ng xoay khi di chu·ªôt */
            border-color: #007bff;
        }

        .stat-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
        .legend { margin-top: 15px; font-size: 13px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .color-box { width: 25px; height: 5px; margin-right: 10px; border-radius: 2px; }

        
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>üöÄ Traffic Monitor</h2>
        
        <div class="input-group">
            <label>ƒêi·ªÉm ƒëi:</label>
            <input type="text" id="start" placeholder="VD: ƒê·∫°i h·ªçc B√°ch Khoa H√† N·ªôi">
        </div>

        <div class="swap-container">
            <button class="swap-btn" onclick="swapLocations()" title="Ho√°n ƒë·ªïi v·ªã tr√≠">‚áÖ</button>
        </div>

        <div class="input-group">
            <label>ƒêi·ªÉm ƒë·∫øn:</label>
            <input type="text" id="end" placeholder="VD: H·ªì T√¢y">
        </div>

        <button onclick="findRoute()" id="btnSearch" class="search-btn">üîç T√¨m ƒê∆∞·ªùng M·ªõi</button>
        
        <div class="legend">
            <h4>Ch√∫ th√≠ch:</h4>
            <div class="legend-item"><span class="color-box" style="background:#00C851"></span> Th√¥ng tho√°ng (>40km/h)</div>
            <div class="legend-item"><span class="color-box" style="background:#ffbb33"></span> ƒê√¥ng ƒë√∫c (20-40km/h)</div>
            <div class="legend-item"><span class="color-box" style="background:#ff4444"></span> T·∫Øc ngh·∫Ωn (20km/h)</div>
        </div>

        <div class="stat-box">
            <h3>üìä Th·ªëng K√™</h3>
            <p>üî¥ ƒêo·∫°n t·∫Øc: <b id="danger" style="color:red">0</b></p>
            <p>üü¢ ƒêo·∫°n tho√°ng: <b id="safe" style="color:green">0</b></p>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([21.0285, 105.8542], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        var baseRouteLayer = L.layerGroup().addTo(map);
        var trafficLayer = L.layerGroup().addTo(map);
        var trafficInterval = null; 

        // --- H√ÄM M·ªöI: X·ª≠ l√Ω ho√°n ƒë·ªïi ---
        function swapLocations() {
            var startInput = document.getElementById('start');
            var endInput = document.getElementById('end');
            
            // L∆∞u gi√° tr·ªã c≈© v√†o bi·∫øn t·∫°m
            var temp = startInput.value;
            
            // Tr√°o ƒë·ªïi gi√° tr·ªã
            startInput.value = endInput.value;
            endInput.value = temp;

            // Hi·ªáu ·ª©ng visual (nh√°y m√†u ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ ƒë·ªïi)
            startInput.style.backgroundColor = "#e8f0fe";
            endInput.style.backgroundColor = "#e8f0fe";
            setTimeout(() => {
                startInput.style.backgroundColor = "white";
                endInput.style.backgroundColor = "white";
            }, 300);
        }

        async function findRoute() {
            var start = document.getElementById('start').value;
            var end = document.getElementById('end').value;
            var btn = document.getElementById('btnSearch');

            if(!start || !end) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");

            if (trafficInterval) {
                clearInterval(trafficInterval);
                trafficInterval = null;
            }

            baseRouteLayer.clearLayers();
            trafficLayer.clearLayers();
            document.getElementById('danger').innerText = "0";
            document.getElementById('safe').innerText = "0";

            btn.innerText = "‚è≥ ƒêang t√≠nh to√°n...";
            btn.disabled = true;

            try {
                var res = await fetch('/api/find-route', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({start, end})
                });
                var data = await res.json();

                if(data.status === 'success') {
                    var latlngs = data.route.map(p => [p.latitude, p.longitude]);
                    L.polyline(latlngs, {color: 'gray', weight: 8, opacity: 0.2}).addTo(baseRouteLayer);
                    map.fitBounds(latlngs, {padding: [50, 50]});

                    updateTraffic();
                    trafficInterval = setInterval(updateTraffic, 3000);
                } else {
                    alert(data.message);
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi server!");
                console.error(e);
            } finally {
                btn.innerText = "üîç T√¨m ƒê∆∞·ªùng M·ªõi";
                btn.disabled = false;
            }
        }

        async function updateTraffic() {
            try {
                var res = await fetch('/api/traffic-data');
                var data = await res.json();
                
                trafficLayer.clearLayers();
                var dangerCount = 0; var safeCount = 0;

                data.forEach(seg => {
                    var color = '#00C851';
                    if (seg.congestion_level > 0.3) color = '#ffbb33';
                    if (seg.congestion_level > 0.6) color = '#ff4444';

                    if (seg.congestion_level > 0.5) dangerCount++; else safeCount++;

                    if (seg.shape && seg.shape.length > 0) {
                        var latlngs = seg.shape.map(p => [p.latitude, p.longitude]);
                        L.polyline(latlngs, {
                            color: color, weight: 6, opacity: 0.9, smoothFactor: 1
                        }).bindPopup(`<b>${seg.name}</b><br>T·ªëc ƒë·ªô: ${seg.speed} km/h`).addTo(trafficLayer);
                    }
                });
                document.getElementById('danger').innerText = dangerCount;
                document.getElementById('safe').innerText = safeCount;
            } catch (e) { console.log("Waiting..."); }
        }
    </script>
</body>
</html>